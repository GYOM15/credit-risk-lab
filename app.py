# -*- coding: utf-8 -*-
"""app.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1KFQL4AijihV4JzmT56mX-nIE0kpJMV10
"""

"""
Credit Lab
"""

import streamlit as st
import pandas as pd
import sys

# Configuration de la page
st.set_page_config(
    page_title="Syst√®me de Cr√©dit Bancaire",
    page_icon="üí∞",
    layout="wide"
)

# Ajouter le chemin pour importer les modules
sys.path.append('./src/')
sys.path.append('./src/preprocessing/')

# Imports
try:
    from credit_engine import CreditDecisionSystem
except ImportError:
    st.error("Erreur : Impossible d'importer credit_engine. V√©rifiez le chemin.")
    st.stop()

# ==============================================================================
# INITIALISATION DU SYST√àME
# ==============================================================================

@st.cache_resource
def load_system():
    """Charge le syst√®me une seule fois (mise en cache)."""
    try:
        system = CreditDecisionSystem('./outputs/models/')
        return system
    except Exception as e:
        st.error(f"Erreur lors du chargement du syst√®me : {e}")
        return None

# ==============================================================================
# INTERFACE PRINCIPALE
# ==============================================================================

def main():
    # Titre
    st.title("Syst√®me de D√©cision de Cr√©dit Bancaire")
    st.markdown("---")

    # Charger le syst√®me
    with st.spinner("Chargement du syst√®me..."):
        system = load_system()

    if system is None:
        st.error("Le syst√®me n'a pas pu √™tre charg√©. V√©rifiez que les mod√®les sont bien dans ./models/")
        st.stop()

    st.success("Syst√®me charg√© avec succ√®s")

    # Sidebar - Navigation
    st.sidebar.title("Navigation")
    page = st.sidebar.radio(
        "Choisissez une page :",
        ["Simulateur Client", "Batch Upload", "√Ä propos"]
    )

    if page == "Simulateur Client":
        page_simulateur(system)
    elif page == "Batch Upload":
        page_batch(system)
    elif page == "√Ä propos":
        page_about()

# ==============================================================================
# PAGE 1 : SIMULATEUR CLIENT
# ==============================================================================

def page_simulateur(system):
    st.header(" Simulateur de Demande de Cr√©dit")
    st.markdown("Renseignez les informations du client pour obtenir une d√©cision automatique.")

    # Formulaire en colonnes
    col1, col2 = st.columns(2)

    with col1:
        st.subheader("Informations Personnelles")
        age = st.number_input("√Çge", min_value=18, max_value=80, value=35, step=1)
        niveau_etude = st.selectbox(
            "Niveau d'√©tudes",
            ["Bac", "Licence", "Master", "Doctorat"]
        )
        ville = st.selectbox(
            "Ville de r√©sidence",
            ["Paris", "Lyon", "Marseille", "Toulouse", "Nice", "Autre"]
        )

    with col2:
        st.subheader("Informations Financi√®res")
        salaire = st.number_input(
            "Salaire annuel (‚Ç¨)",
            min_value=0,
            max_value=200000,
            value=45000,
            step=1000
        )
        epargne = st.number_input(
            "√âpargne totale (‚Ç¨)",
            min_value=0,
            max_value=500000,
            value=10000,
            step=1000
        )
        score_credit = st.slider(
            "Score de cr√©dit externe",
            min_value=0,
            max_value=100,
            value=75,
            step=5
        )

    # Param√®tres du pr√™t
    st.subheader("Param√®tres du Pr√™t")
    duration = st.slider(
        "Dur√©e du pr√™t (mois)",
        min_value=12,
        max_value=120,
        value=60,
        step=12
    )

    # Bouton de simulation
    if st.button("Simuler la Demande", type="primary"):
        # Cr√©er le DataFrame client
        client = pd.DataFrame({
            'Age': [age],
            'Salaire_Annuel': [salaire],
            'Epargne_Totale': [epargne],
            'Score_Credit_Externe': [score_credit],
            'Niveau_Etude': [niveau_etude],
            'Ville': [ville]
        })

        # Pr√©diction
        with st.spinner("Analyse en cours..."):
            try:
                decision = system.predict(client, duration_months=duration)

                # Affichage de la d√©cision
                st.markdown("---")
                display_decision(decision)

            except Exception as e:
                st.error(f"Erreur lors de la pr√©diction : {e}")
                st.exception(e)

# ==============================================================================
# PAGE 2 : BATCH UPLOAD
# ==============================================================================

def page_batch(system):
    st.header("üìä Analyse en Batch")
    st.markdown("Uploadez un fichier CSV contenant plusieurs clients.")

    # Upload fichier
    uploaded_file = st.file_uploader(
        "Choisissez un fichier CSV",
        type=['csv']
    )

    if uploaded_file is not None:
        try:
            # Lire le fichier
            df = pd.read_csv(uploaded_file)

            st.subheader("Aper√ßu des donn√©es")
            st.dataframe(df.head())

            # V√©rifier les colonnes requises
            required_cols = ['Age', 'Salaire_Annuel', 'Epargne_Totale',
                           'Score_Credit_Externe', 'Niveau_Etude', 'Ville']

            missing_cols = [col for col in required_cols if col not in df.columns]

            if missing_cols:
                st.error(f"Colonnes manquantes : {missing_cols}")
                st.stop()

            # Param√®tres
            duration = st.slider(
                "Dur√©e du pr√™t (mois)",
                min_value=12,
                max_value=120,
                value=60,
                step=12,
                key="batch_duration"
            )

            # Bouton d'analyse
            if st.button("Analyser tous les clients", type="primary"):
                with st.spinner(f"Analyse de {len(df)} clients..."):
                    decisions = system.predict_batch(df, duration_months=duration)

                    # Cr√©er DataFrame de r√©sultats
                    results = pd.DataFrame(decisions)

                    # Ajouter les infos clients
                    results_full = pd.concat([
                        df[['Age', 'Salaire_Annuel', 'Niveau_Etude']].reset_index(drop=True),
                        results.reset_index(drop=True)
                    ], axis=1)

                    st.success(f"Analyse termin√©e pour {len(df)} clients")

                    # Statistiques
                    st.subheader("Statistiques Globales")
                    col1, col2, col3 = st.columns(3)

                    with col1:
                        acceptes = (results_full['Decision'] == 'Accept√©').sum()
                        st.metric("Accept√©s", acceptes,
                                 delta=f"{acceptes/len(df)*100:.1f}%")

                    with col2:
                        refuses = (results_full['Decision'] == 'Refus√©').sum()
                        st.metric("Refus√©s", refuses,
                                 delta=f"{refuses/len(df)*100:.1f}%")

                    with col3:
                        ajustes = (results_full['Decision'] == 'Ajust√©').sum()
                        st.metric("Ajust√©s", ajustes,
                                 delta=f"{ajustes/len(df)*100:.1f}%")

                    # Tableau complet
                    st.subheader("R√©sultats D√©taill√©s")
                    st.dataframe(results_full, use_container_width=True)

                    # T√©l√©chargement
                    csv = results_full.to_csv(index=False).encode('utf-8')
                    st.download_button(
                        label="T√©l√©charger les r√©sultats (CSV)",
                        data=csv,
                        file_name="resultats_credit.csv",
                        mime="text/csv"
                    )

        except Exception as e:
            st.error(f"Erreur lors de la lecture du fichier : {e}")
            st.exception(e)

# ==============================================================================
# PAGE 3 : √Ä PROPOS
# ==============================================================================

def page_about():
    st.header("√Ä Propos")

    st.markdown("""
    ## Syst√®me de D√©cision de Cr√©dit Bancaire

    Cette application utilise un syst√®me de Machine Learning pour √©valuer
    automatiquement les demandes de cr√©dit bancaire.

    ### Architecture du Syst√®me

    1. **Preprocessing Pipeline**
       - Nettoyage des donn√©es
       - Feature engineering (ratio √©pargne/salaire)
       - Imputation intelligente
       - Encodage (ordinal + one-hot)
       - Scaling multi-strat√©gie

    2. **Mod√®le de Classification**
       - R√©gression Logistique calibr√©e
       - Pr√©diction du risque de d√©faut
       - Seuil optimis√© pour 75% de recall

    3. **Mod√®le de R√©gression**
       - Ridge avec transformation log
       - Estimation du montant du pr√™t
       - Smearing factor pour correction du biais

    4. **R√®gles M√©tier**
       - Salaire minimum : 18,000‚Ç¨/an
       - Taux d'endettement maximum : 33%
       - Taux d'int√©r√™t dynamique selon le risque

    ### Technologies Utilis√©es

    - **Python** : Langage principal
    - **Scikit-learn** : Pipeline ML
    - **Streamlit** : Interface web
    - **Pandas** : Manipulation de donn√©es

    ### Auteur

    Projet d√©velopp√© dans le cadre d'un pipeline complet de Data Science
    appliqu√© au cr√©dit bancaire.

    ### Contact

    Pour toute question ou suggestion, n'h√©sitez pas √† me contacter.
    """)

# ==============================================================================
# FONCTION D'AFFICHAGE DE LA D√âCISION
# ==============================================================================

def display_decision(decision):
    """Affiche la d√©cision de mani√®re visuelle."""

    # Couleur selon la d√©cision
    if decision['Decision'] == 'Accept√©':
        color = "green"
        icon = "‚úÖ"
    elif decision['Decision'] == 'Ajust√©':
        color = "orange"
        icon = "‚ö†Ô∏è"
    else:
        color = "red"
        icon = "‚ùå"

    # Titre de la d√©cision
    st.markdown(f"## {icon} D√©cision : **:{color}[{decision['Decision']}]**")

    # Affichage selon le type de d√©cision
    if decision['Decision'] in ['Accept√©', 'Ajust√©']:
        col1, col2, col3 = st.columns(3)

        with col1:
            st.metric(
                "Montant Final",
                f"{decision.get('Montant_Final', 0):,.0f} ‚Ç¨"
            )

        with col2:
            st.metric(
                "Mensualit√©",
                f"{decision.get('Mensualite', 0):,.2f} ‚Ç¨"
            )

        with col3:
            st.metric(
                "Taux d'Int√©r√™t",
                f"{decision.get('Taux_Propose', 0)*100:.1f}%"
            )

        # D√©tails suppl√©mentaires
        with st.expander("D√©tails de l'Analyse"):
            st.write(f"**Montant propos√© par le mod√®le** : {decision.get('Montant_Modele', 0):,.2f} ‚Ç¨")
            st.write(f"**Capacit√© d'emprunt maximale** : {decision.get('Montant_Max_Autorise', 0):,.2f} ‚Ç¨")
            st.write(f"**Niveau de risque** : {decision.get('Niveau_Risque', 0):.1%}")
            st.write(f"**Ratio d'endettement** : {decision.get('Ratio_Endettement', 0):.1%}")

            # Jauge de risque
            risque = decision.get('Niveau_Risque', 0)
            st.progress(risque, text=f"Risque de d√©faut : {risque:.1%}")

            # Justification
            st.info(f" {decision.get('Justification', 'N/A')}")

    else:
        # Cas refus√©
        st.error(f"**Motif** : {decision.get('Raison', decision.get('Motif', 'Non sp√©cifi√©'))}")

        if 'Niveau_Risque' in decision and decision['Niveau_Risque'] is not None:
            st.write(f"**Niveau de risque** : {decision['Niveau_Risque']:.1%}")

        if 'Probabilit√©_D√©faut' in decision:
            st.write(f"**Probabilit√© de d√©faut** : {decision['Probabilit√©_D√©faut']:.1%}")

# ==============================================================================
# POINT D'ENTR√âE
# ==============================================================================

if __name__ == "__main__":
    main()